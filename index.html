<!doctype html>
<html lang="en-gb">
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<title>Tube Usage</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href='http://fonts.googleapis.com/css?family=Signika+Negative:300,400,600,700|Signika:400,300,600,700|Hind:400,300,500,600,700|Chivo:400,900italic,900,400italic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="assets/less/styles.css">
</head>
<body>
	<div id="container" class="loading"></div>
	<div id="menu">
		<div class="container">
			<div class="row">
				<div class="col-md-3">
					<div class="title">
						<h1><i class="roundel"></i> London Underground Usage</h1>
						<h2>How many people use the Tube <span class="hidden-md">stations</span> around the clock?</h2>
						<p class="phone-instructions">Rotate phone to switch between the infographic and the visualisation options.</p>
						<a id="autoplay" class="paused"><i></i> <span>Start</span> autoplay</a>
					</div>
				</div>
				<div class="options col-md-9">
					<div class="row">
						<div class="option direction col-sm-3">
							<h2>Commuters Flow</h2>
							<div class="options-bar">
								<label class="radio-inline">
									<input type="radio" name="direction" id="direction-all" value="all" checked><span class="all" title="All commuters"><div>All commuters</div></span>
								</label>
								<label class="radio-inline">
									<input type="radio" name="direction" id="direction-in" value="in"><span class="in" title="Commuters entering the Tube"><div>Commuters entering the Tube</div></span>
								</label>
								<label class="radio-inline">
									<input type="radio" name="direction" id="direction-out" value="out"><span class="out" title="Commuters exiting the Tube"><div>Commuters exiting the Tube</div></span>
								</label>
							</div>
						</div>

						<div class="option time col-sm-4">
							<h2>Time</h2>
							<div class="range-container">
								<label id="current-time">12:00</label>
								<input type="range" name="time" min="0" max="24" step="1" value="12">
							</div>
						</div>

						<div class="option day col-sm-5">
							<h2>Day of the week</h2>
							<div class="options-bar">
								<label class="radio-inline">
									<input type="radio" name="day" id="day-monday" value="Mon" checked><span title="Monday">Mon</span>
								</label>
								<label class="radio-inline">
									<input type="radio" name="day" id="day-tuesday" value="Tue"><span title="Tuesday">Tue</span>
								</label>
								<label class="radio-inline">
									<input type="radio" name="day" id="day-wednesday" value="Wed"><span title="Wednesday">Wed</span>
								</label>
								<label class="radio-inline">
									<input type="radio" name="day" id="day-thursday" value="Thu"><span title="Thursday">Thu</span>
								</label>
								<label class="radio-inline">
									<input type="radio" name="day" id="day-friday" value="Fri"><span title="Friday">Fri</span>
								</label>
								<label class="radio-inline">
									<input type="radio" name="day" id="day-saturday" value="Sat"><span title="Saturday">Sat</span>
								</label>
								<label class="radio-inline">
									<input type="radio" name="day" id="day-sunday" value="Sun"><span title="Sunday">Sun</span>
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
	<script type="text/javascript">

		var heatmapYellow = "#ffce00";
		var heatmapRed = '#ba0000';
		var mainColor = "#ff0000"; // red, to be shaded
		var hoverColor = "#000";
		var circleOpacity = 0.7;

		// Converts from degrees to radians.
		Math.radians = function(degrees) {
			return degrees * Math.PI / 180;
		};
		 
		// Converts from radians to degrees.
		Math.degrees = function(radians) {
			return radians * 180 / Math.PI;
		};

		var earthRadius = 6367; //radius in km
		function convertSphericalToCartesian(latitude, longitude) {
			var lat = Math.radians(latitude);
			var lon = Math.radians(longitude);
			var x = earthRadius * Math.cos(lat) * Math.cos(lon);
			var y = earthRadius * Math.cos(lat) * Math.sin(lon);
			return {x: y + 45, y: x - 3944};
		}

		function shadeColor(color, shade) {
			var colorInt = parseInt(color.substring(1),16);

			var R = (colorInt & 0xFF0000) >> 16;
			var G = (colorInt & 0x00FF00) >> 8;
			var B = (colorInt & 0x0000FF) >> 0;

			R = R + Math.floor((shade/255)*R);
			G = G + Math.floor((shade/255)*G);
			B = B + Math.floor((shade/255)*B);

			var newColorInt = (R<<16) + (G<<8) + (B);
			var newColorStr = "#"+newColorInt.toString(16);

			return newColorStr;
		}

		var colorScale;
		var data;
		var circles;
		var day;
		var time;
		var direction;

		d3.json("data.json", function(error, json) {
			if (error) return console.warn(error);
			data = json;
			init();
		});

		function init() {
			var container = d3.select("#container");

			container.transition().duration(900).attr({
				class: ""
			});

			var canvas = container.append("svg");

			canvas.attr({
				"preserveAspectRatio": "xMidYMid",
				"viewBox": "0 0 1300 630",
			});

			/*
			// background rectangle used
			// to tweak svg viewport size
			canvas.append("rect").attr({
				width: "100%",
				height: "100%",
				fill: "#dadada"
			});
			*/

			colorScale = d3.scale.linear()
						.domain([0, d3.max(data, function (d) { return 90; })])
						// .range(["#ff0000", "#000000"]);
						.range([heatmapYellow, heatmapRed]);

			var tip = d3.tip()
				.attr('class', 'd3-tip')
				.offset([-10, 0])
				.html(function(d) {
					return d.name;
					// return d.name + "<br/>" + numberOfPeople(d, day, time, direction);
				});

			circles = canvas.selectAll("circle")
							.data(data)
							.enter()
								.append("circle")
								.attr({
									cx: function(d) {return ((convertSphericalToCartesian(d.coordinates.lat, d.coordinates.lon)).x) * 20;},
									cy: function(d) {return ((convertSphericalToCartesian(d.coordinates.lat, d.coordinates.lon)).y) * 20;},
									r: 3,
									opacity: circleOpacity,
									class: "station-circle",
									name: function(d) {return d.name;},
								})
								.on('mouseover', function(d) {
									d3.select(this).attr({
										fill: hoverColor
									});
									tip.show(d);
								})
								.on('mouseout', function(d) {
									tip.hide(d);
									d3.select(this).attr({
										fill: function() {
											return d3.select(this).attr("data-fill");
										}
									});
								});
			circles.call(tip);

			redraw();
			updateTimeLabel();
		}

		d3.selectAll('input[name="day"]').on("change", function() {
			redraw();
		});

		d3.select('input[name="time"]').on("change", function() {
			updateTimeLabel();
			redraw();
		});

		d3.select('input[name="time"]').on("input", function() {
			updateTimeLabel();
			redraw();
		});

		d3.selectAll('input[name="direction"]').on("change", function() {
			redraw();
		});

		function updateTimeLabel() {
			var time = d3.select('input[type="range"]').node().value.toString();
			d3.select('#current-time').text(time + ":00").style({
				"margin-left": function() {
					var margin = time * 3.5;

					if (margin > 83) margin = 83;

					return margin + '%';
				}
			})
		}

		function numberOfPeople(circleData, day, time, direction) {
			if (circleData[day] == undefined) {
				return 0;
			} else if (circleData[day][time] == undefined) {
				return 0;
			} else {
				return circleData[day][time][direction];
			}
		}

		function redraw() {
			day = d3.select('input[name="day"]:checked').node().value;
			time = d3.select('input[type="range"]').node().value.toString();
			direction = d3.select('input[name="direction"]:checked').node().value;

			// fix bug in which data for single digit hours is not displayed
			if (time.length == 1) {time = "0" + time;}

			circles.sort(function (a, b) {	// select the parent and sort the path's
				if (numberOfPeople(a.data, day, time, direction) > numberOfPeople(b.data, day, time, direction)) return -1;				// a is not the hovered element, send "a" to the back
				else return 1;								// a is the hovered element, bring "a" to the front
			});

			if (circles !== undefined) {
				circles.transition().duration(900).ease('elastic', 1, 0.75).attr({
				// circles.transition().duration(900).ease('quad').attr({
					fill: function(d) {
						return colorScale(numberOfPeople(d.data, day, time, direction));
					},
					"data-fill": function(d) {
						return colorScale(numberOfPeople(d.data, day, time, direction));
					},
					r: function(d) {
						var size = numberOfPeople(d.data, day, time, direction) * 0.9;
						
						if (size <= 0) {
							return 0;
						} else if (size > 0 && size < 2) {
							return size + 2;
						} else if (size > 50) {
							return size * 0.1 + 50;
						} else {
							return size;
						}
					}
				}).style({
					"z-index": function(d) {
						return -(numberOfPeople(d.data, day, time, direction));
					}
				});
			}
		}

		function autoplay() {

		}

	</script>

</body>
</html>